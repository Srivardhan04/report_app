<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ report_title }}</title>
<style>
    @page {
        size: A4;
        margin: 10mm 12mm;
    }

    :root {
        --kl-red: #c62828;
        --kl-dark: #222;
        --kl-gray: #e0e0e0;
        --kl-light-bg: #fafafa;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: "Arial", "Helvetica Neue", sans-serif;
        font-size: 10.5px;
        color: var(--kl-dark);
        line-height: 1.32;
    }

    /* ═══════════ HEADER ═══════════ */
    header {
        display: flex;
        align-items: center;
        border-bottom: 2.5px solid var(--kl-red);
        padding-bottom: 6px;
        margin-bottom: 8px;
    }

    header .logo {
        width: 62px;
        height: auto;
        margin-right: 12px;
        flex-shrink: 0;
    }

    header .header-text {
        flex: 1;
        text-align: center;
    }

    header .header-text h1 {
        font-size: 19px;
        font-weight: 800;
        color: var(--kl-red);
        letter-spacing: 0.5px;
        margin: 0;
    }

    header .header-text h2 {
        font-size: 10.5px;
        font-weight: 600;
        color: var(--kl-dark);
        margin: 1px 0 0 0;
    }

    header .header-text h3 {
        font-size: 10px;
        font-weight: 600;
        color: #444;
        margin: 1px 0 0 0;
    }

    header .header-text .date {
        font-size: 9px;
        color: #777;
        margin-top: 1px;
    }

    /* ═══════════ SECTIONS ═══════════ */
    .section-label {
        font-size: 10.5px;
        font-weight: 700;
        color: var(--kl-red);
        border-bottom: 1.5px solid var(--kl-red);
        padding-bottom: 1px;
        margin: 10px 0 5px 0;
        text-transform: uppercase;
        letter-spacing: 0.4px;
    }

    /* ═══════════ STUDENT DETAILS ═══════════ */
    .student-details {
        margin-bottom: 6px;
    }

    .details-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0;
    }

    .details-grid .detail-item {
        width: 50%;
        padding: 2px 6px;
        font-size: 10px;
        border-bottom: 0.5px solid #eee;
    }

    .details-grid .detail-item .lbl {
        font-weight: 700;
        color: #555;
        display: inline-block;
        min-width: 100px;
    }

    .details-grid .detail-item .val {
        color: var(--kl-dark);
    }

    /* ═══════════ TABLES ═══════════ */
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
        margin-bottom: 4px;
    }

    th {
        background-color: var(--kl-red);
        color: #fff;
        padding: 4px 3px;
        text-align: center;
        font-weight: 700;
        font-size: 9.5px;
        border: 1px solid #a02020;
    }

    td {
        padding: 3px 3px;
        border: 1px solid #bbb;
        text-align: center;
        vertical-align: middle;
    }

    tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    /* ═══════════ ATTENDANCE COLORS ═══════════ */
    .att-red {
        color: #b71c1c;
        background-color: #fdecea !important;
        font-weight: bold;
    }

    .att-yellow {
        color: #f57f17;
        background-color: #fff8e1 !important;
        font-weight: bold;
    }

    .att-green {
        color: #1b5e20;
        background-color: #e8f5e9 !important;
        font-weight: bold;
    }

    /* ═══════════ GRADE FAIL ═══════════ */
    .grade-fail {
        color: #b71c1c;
        background-color: #fdecea !important;
        font-weight: bold;
    }

    /* ═══════════ OVERALL STATS ═══════════ */
    .overall-line {
        font-size: 10px;
        font-weight: 700;
        margin: 3px 0 3px 0;
    }

    .overall-line.red { color: #b71c1c; }
    .overall-line.yellow { color: #f57f17; }
    .overall-line.green { color: #1b5e20; }

    /* ═══════════ NOTICE BLOCK (shared by attendance & backlog) ═══════════ */
    .notice-block {
        background: #fff8f0;
        border-left: 3px solid var(--kl-red);
        padding: 5px 8px;
        margin: 5px 0 8px 0;
        font-size: 9.5px;
        line-height: 1.38;
        text-align: justify;
        color: #333;
    }

    .notice-block strong {
        color: var(--kl-red);
    }

    .notice-telugu {
        margin-top: 4px;
        font-size: 8.5px;
        color: #444;
        line-height: 1.45;
        font-style: italic;
    }

    /* ═══════════ COUNSELOR ═══════════ */
    .counselor-section {
        margin-bottom: 6px;
    }

    .counselor-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0;
    }

    .counselor-grid .detail-item {
        width: 50%;
        padding: 2px 6px;
        font-size: 10px;
        border-bottom: 0.5px solid #eee;
    }

    .counselor-grid .detail-item .lbl {
        font-weight: 700;
        color: #555;
        display: inline-block;
        min-width: 120px;
    }

    .counselor-grid .detail-item .val {
        color: var(--kl-dark);
    }

    /* ═══════════ FOOTER ═══════════ */
    footer {
        margin-top: 10px;
        padding-top: 6px;
        border-top: 1.5px solid var(--kl-red);
        font-size: 9.5px;
        line-height: 1.45;
    }

    footer .sign-block {
        text-align: left;
    }

    footer .sign-block .sincerely {
        font-weight: 700;
        font-size: 10.5px;
        color: var(--kl-dark);
    }

    footer .sign-block .hod-name {
        font-weight: 700;
        font-size: 10px;
        color: var(--kl-red);
    }

    footer .sign-block .dept-line {
        font-size: 9.5px;
        color: #555;
    }
</style>
</head>
<body>

<!-- ═══ HEADER ═══ -->
<header>
    {% if logo_base64 %}
    <img src="{{ logo_base64 }}" class="logo" alt="KL University Logo">
    {% endif %}
    <div class="header-text">
        <h1>KL University</h1>
        <h2>{{ department_name }}</h2>
        <h3>{{ report_title }}</h3>
        <p class="date">Date: {{ generated_date }}</p>
    </div>
</header>

<!-- ═══ STUDENT DETAILS (no email/phone — not in CSV) ═══ -->
<section class="student-details">
    <div class="section-label">Student Details</div>
    <div class="details-grid">
        <div class="detail-item"><span class="lbl">Student ID:</span> <span class="val">{{ student.student_id }}</span></div>
        <div class="detail-item"><span class="lbl">Student Name:</span> <span class="val">{{ student.student_name }}</span></div>
        {% if student.section %}
        <div class="detail-item"><span class="lbl">Section:</span> <span class="val">{{ student.section }}</span></div>
        {% endif %}
        {% if student.year %}
        <div class="detail-item"><span class="lbl">Year:</span> <span class="val">{{ student.year }}</span></div>
        {% endif %}
        {% if student.semester %}
        <div class="detail-item"><span class="lbl">Semester:</span> <span class="val">{{ student.semester }}</span></div>
        {% endif %}
        {% if student.branch %}
        <div class="detail-item"><span class="lbl">Branch:</span> <span class="val">{{ student.branch }}</span></div>
        {% endif %}
    </div>
</section>

<!-- ═══ ATTENDANCE TABLE ═══ -->
{% if student.attendance_records %}
<section class="attendance-section">
    <div class="section-label">Current Semester Attendance</div>
    <table>
        <thead>
            <tr>
                <th style="width:16%">Subject Code</th>
                <th style="width:34%">Subject Name</th>
                <th style="width:14%">Classes Held</th>
                <th style="width:18%">Classes Attended</th>
                <th style="width:18%">Attendance %</th>
            </tr>
        </thead>
        <tbody>
        {% for att in student.attendance_records %}
            <tr>
                <td>{{ att.subject_code }}</td>
                <td style="text-align:left; padding-left:6px;">{{ att.subject_name }}</td>
                <td>{{ att.classes_held }}</td>
                <td>{{ att.classes_attended }}</td>
                <td class="{{ att.attendance_class }}">{{ "%.1f"|format(att.attendance_percentage) }}%</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Overall Attendance -->
    <p class="overall-line {% if student.overall_attendance < 75 %}red{% elif student.overall_attendance < 80 %}yellow{% else %}green{% endif %}">
        Overall Attendance: {{ "%.1f"|format(student.overall_attendance) }}%
    </p>

    <!-- Attendance Notice — ONLY if any subject < 75% -->
    {% set low_att_subjects = [] %}
    {% for att in student.attendance_records %}
        {% if att.attendance_percentage < 75.0 %}
            {% if low_att_subjects.append(att.subject_name ~ ' (' ~ "%.1f"|format(att.attendance_percentage) ~ '%)') %}{% endif %}
        {% endif %}
    {% endfor %}

    {% if low_att_subjects %}
    <div class="notice-block">
        <strong>Notice Regarding Low Attendance:</strong>
        It is hereby brought to the notice of the parent/guardian that the student's attendance is below the minimum
        required threshold of 75% in the following subject(s): <strong>{{ low_att_subjects|join(', ') }}</strong>.
        As per the regulations of Koneru Lakshmaiah Education Foundation (KL University), students who fail to
        maintain a minimum of 75% attendance in any registered course are liable for detention and may be
        debarred from appearing in the end-semester examinations. The parent/guardian is earnestly requested to
        take immediate note of this matter and ensure that the student attends all scheduled classes henceforth.
        {% if enable_telugu_notice %}
        <div class="notice-telugu">
            <strong>సూచన (తెలుగు అనువాదం):</strong>
            విద్యార్థి హాజరు శాతం పై పేర్కొన్న సబ్జెక్టు(ల)లో — {{ low_att_subjects|join(', ') }} — నిర్ణీత కనీస పరిమితి 75% కంటే తక్కువగా
            ఉన్నట్లు తల్లిదండ్రులు/సంరక్షకుల దృష్టికి తీసుకురావడమైనది. కేఎల్ విశ్వవిద్యాలయ నిబంధనల ప్రకారం,
            ఏదైనా నమోదైన కోర్సులో 75% కనీస హాజరును నిర్వహించని విద్యార్థులు డిటెన్షన్‌కు గురవుతారు మరియు
            సెమిస్టర్ చివరి పరీక్షలకు హాజరు కాకుండా నిలిపివేయబడవచ్చు. తల్లిదండ్రులు/సంరక్షకులు ఈ విషయాన్ని
            తక్షణమే గమనించి, విద్యార్థి ఇకపై అన్ని షెడ్యూల్డ్ తరగతులకు హాజరయ్యేలా చూడవలసిందిగా మనవి.
        </div>
        {% endif %}
    </div>
    {% endif %}
</section>
{% endif %}

<!-- ═══ PREVIOUS SEMESTER RESULTS ═══ -->
{% if student.previous_results %}
<section class="results-section">
    <div class="section-label">Previous Semester Results</div>
    <table>
        <thead>
            <tr>
                <th style="width:18%">Subject Code</th>
                <th style="width:44%">Subject Name</th>
                <th style="width:18%">Grade</th>
                <th style="width:20%">Credits</th>
            </tr>
        </thead>
        <tbody>
        {% for res in student.previous_results %}
            <tr>
                <td>{{ res.subject_code }}</td>
                <td style="text-align:left; padding-left:6px;">{{ res.subject_name }}</td>
                <td{% if res.is_backlog %} class="grade-fail"{% endif %}>{{ res.grade }}</td>
                <td>{{ res.credits }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Previous Semester CGPA -->
    {% if student.cgpa is not none %}
    <p class="overall-line" style="color: #1a237e;">
        Previous Semester CGPA: {{ "%.2f"|format(student.cgpa) }}
    </p>
    {% endif %}

    {% if student.backlog_count > 0 %}
    <!-- Backlog Notice -->
    <div class="notice-block">
        <strong>Notice Regarding Backlogs:</strong>
        It is observed that the student has backlog(s) in the following subject(s):
        <strong>{{ student.backlog_subjects|join(', ') }}</strong>.
        The student is advised to take dedicated academic effort to clear the above-mentioned backlog(s)
        at the earliest. The department will provide necessary academic guidance and closely monitor
        the student's progress.
        {% if enable_telugu_notice %}
        <div class="notice-telugu">
            <strong>సూచన (తెలుగు అనువాదం):</strong>
            విద్యార్థికి క్రింది సబ్జెక్టు(ల)లో — {{ student.backlog_subjects|join(', ') }} — బ్యాక్‌లాగ్(లు) ఉన్నట్లు గమనించబడింది.
            విద్యార్థి పై పేర్కొన్న బ్యాక్‌లాగ్(లను) వీలైనంత త్వరగా క్లియర్ చేయడానికి అంకితమైన
            అకడమిక్ కృషి చేయాలని సూచించబడింది. విభాగం అవసరమైన అకడమిక్ మార్గదర్శకత్వం
            అందించి, విద్యార్థి పురోగతిని నిశితంగా పర్యవేక్షిస్తుంది.
        </div>
        {% endif %}
    </div>
    {% else %}
    <p class="overall-line green">No Backlogs &mdash; All Subjects Cleared</p>
    {% endif %}
</section>
{% endif %}

<!-- ═══ COUNSELOR / MENTOR DETAILS ═══ -->
{% if student.counselor_name or student.counselor_id or student.counselor_email or student.counselor_phone %}
<section class="counselor-section">
    <div class="section-label">Counselor / Mentor Details</div>
    <div class="counselor-grid">
        <div class="detail-item"><span class="lbl">Counselor Name:</span> <span class="val">{{ student.counselor_name or 'N/A' }}</span></div>
        <div class="detail-item"><span class="lbl">Counselor ID:</span> <span class="val">{{ student.counselor_id or 'N/A' }}</span></div>
        <div class="detail-item"><span class="lbl">Counselor Email:</span> <span class="val">{{ student.counselor_email or 'N/A' }}</span></div>
        <div class="detail-item"><span class="lbl">Counselor Phone:</span> <span class="val">{{ student.counselor_phone or 'N/A' }}</span></div>
    </div>
</section>
{% endif %}

<!-- ═══ FOOTER (sign-off only — no duplicate notices) ═══ -->
<footer>
    <div class="sign-block">
        <div class="sincerely">Sincerely,</div>
        <div class="sincerely">Head of the Department</div>
        <div class="hod-name">{{ hod_name }}</div>
        <div class="dept-line">{{ department_name }}</div>
    </div>
</footer>

</body>
</html>
